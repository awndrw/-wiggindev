#!/usr/bin/env bash
. "$(dirname -- "$0")/_/husky.sh"

yarn lint-staged --allow-empty

## CREATE RELEASE WORKFLOW
PREFIX="packages/"
SUFFIX="/package.json"
# Get array of paths and remove prefix/suffix from each
PATHS=(packages/*/package.json)
DIRS=("${PATHS[@]#$PREFIX}")
DIRS=("${DIRS[@]%$SUFFIX}")
# Format as JSON string (ex ["events","hooks","utils"])
JSONDIRS=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${DIRS[@]}")
# Copy template to workflows directory
cp .github/templates/release.yaml .github/workflows/release.yaml
# Replace %%PACKAGES%% in new workflow with JSON string
sed -i .bak "s/%%PACKAGES%%/$JSONDIRS/" .github/workflows/release.yaml
# Add warning comment to first line of generated workflow
sed -i .bak '1i\
########\
### WARNING: DO NOT EDIT THIS FILE DIRECTLY.\
### This file is regenerated before every commit (see .husky/pre-commit)\
### Instead, modify the template:\
### .github/templates/release.yaml\
########\
' .github/workflows/release.yaml
# Add to git
git add .github/workflows/release.yaml
